CREATE TABLE [dbo].[Pages](
	[PageID]		[TINYINT] PRIMARY KEY IDENTITY(1,1) NOT NULL,
	[Name]			[VARCHAR](25) NULL,
	[ProjectID]		[TINYINT] REFERENCES dbo.Projects(PROJECTID),
	[EnteredBy]		[INT] REFERENCES dbo.Users(USERID),
	[CreatedDate]	[DATE] DEFAULT GETDATE(),
	[RecStatus]		[CHAR](1) DEFAULT 'A'
)

insert into Pages(Name,ProjectID)values('BooksReview',1)

GO

Create table dbo.Comments(
CommentsID			Int identity(1,1)primary key,
MasterCommentsID	Int NULL,
ProjectID			TINYINT references [Projects]([ProjectID]),
UserId				int references dbo.Users(UserId),
MasterPageID		tinyint references dbo.Pages(PageID),
ChildPageID			int,
Comments			nvarchar(2050)NOT NULL,
CreatedDate			datetime,
RecStatus			Char(1) default 'A')

Go

-- SP: USP_AddComments
CREATE Procedure dbo.USP_AddComments( 
	@ProjectID TINYINT, @UserID INT, 
	@Name nvarchar(100), @Email varchar(35), 
	@Password Nvarchar(60), @Mobile varchar(15), 
	@MasterPageID TINYINT, @ChildPageID INT,
	@Comments nvarchar(2050), 
	@Result VARCHAR(7) Output) AS 
BEGIN
   Set NoCount on 
      BEGIN TRY 
		 IF(@UserID > 0) 
				BEGIN
					Insert into dbo.Comments(ProjectID, UserID, MasterPageID, ChildPageID, Comments, CreatedDate)
					Values (@ProjectID, @UserID, @MasterPageID, @ChildPageID, @Comments, GETDATE())
						SET @Result='Success'
						return @Result 
				END
         ELSE
             BEGIN
					Insert into dbo.Users(Name,UserName, MailID, Password, Mobile,ProfessionID,UserTypeID)
					values (@Name, '', @Email, @Password, @Mobile,1, 6) --UserTypeID=6 (User) 
						SELECT @Result = scope_identity();
                  
					Insert into dbo.Comments(ProjectID, UserID, MasterPageID, ChildPageID, Comments, CreatedDate)
					Values (@ProjectID, @Result, @MasterPageID, @ChildPageID, @Comments, GETDATE())

						SET @Result='Success'
						return @Result 
               END
      END TRY 
      BEGIN CATCH 
			EXEC dbo.USP_GetErrorInfo 
      END CATCH 
END
-- SP: USP_AddComments

GO

CREATE Procedure dbo.USP_GetAllComments
AS
BEGIN
Set NoCount on
	Select CommentsID,MasterCommentsID, ProjectID, C.UserID, MasterPageID, ChildPageID, Comments, C.CreatedDate,
			U.UserName
			FROM dbo.Comments C
			JOIN dbo.Users U on C.UserID = U.UserID
END

GO

CREATE Procedure dbo.USP_GetAllCommentsByPageID
(
	@MasterPageID TINYINT, 
	@ChildPageID INT
)
AS
BEGIN
Set NoCount on
	Select CommentsID, MasterCommentsID, ProjectID, C.UserID, MasterPageID, ChildPageID, Comments, C.CreatedDate,
			U.UserName
			FROM dbo.Comments C
			JOIN dbo.Users U on C.UserID = U.UserID
			WHERE MasterPageID = @MasterPageID AND ChildPageID = @ChildPageID 
END

GO